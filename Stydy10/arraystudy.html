<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, width=device-width">
	<title>Study10</title>
	<link crossorigin="anonymous" media="all" rel="stylesheet" href="css/arraystudy.css">
	<link crossorigin="anonymous" media="all" rel="stylesheet" href="css/reset.css">
	<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
	<script type="text/javascript">

		localStorage.setItem('totalPrice', 300000)
		localStorage.setItem('name', "BJH")


		window.onload = function() {
			
			let _localPoint = document.getElementById('price').innerHTML += localStorage.getItem('totalPrice')

			_f_initPriceButton()
			
			
			const chklist = document.getElementById('itemListWrap')
			const cart_view = document.getElementById('cartlistWrap')
			let __HTML = ''

			//제품 배열
			let martitem = []

			_f_initAjaxList(martitem)

			// 카드에 담은 리스트 배열
			let cartArray = new Array(
			)
			// 토탈 구매 금액에 대한 추가 배열
			let cartArrayTotal = new Array (
			)
			// 구매 토탈 배열 구매리스트 + 최종 합계금액
			let buyArray = new Array (
			)
			
			
			

			const _martItem = document.querySelectorAll('.item')
			const _carBt = document.getElementById('cartbt')
			const _count = document.getElementsByClassName('.counts')
			
			_f_initWishListButton(_carBt, cartArray, cartArrayTotal)

			
			for( var i=0; _martItem.length > i; i++ ){

				let _cheked = _martItem[i].querySelector('.name')
				
				_cheked.addEventListener('change', function(event){

					let _target = event.currentTarget
					let _target_data = _target.dataset.price; // 해당 타켓의 가격
					let _target_name = _target.value; // 해당 타켓의 이름 == 값
					let _target_count = _target.parentNode.querySelector('.counts')	//클릭된 리스트의 개수 인풋박스
					let _target_this = this.checked
					let _checkdAll = document.getElementsByClassName('active')
					
					// 제품의 체크박스가 체크 되었을때
					if(_target.checked){
						
						cartArray.push({name : _target_name, price : _target_data, count : 1, amount :_target_data * 1})
												
						_target_count.value = 1 //카운트인풋1

						_target.classList.add('active')

						_target_count.removeAttribute('disabled') //카운트disabled삭제

						_carBt.removeAttribute('disabled') //장바구니버튼disabled삭제
					
						//넘버박스 카운트 숫자 변경에 따른 이벤트 생성
						_target_count.addEventListener('change', function(event){
							
							//해당 제품의 체크박스와 동일한 넘버박스 인덱스 찾기
							let cartArray_find = cartArray.findIndex(function(find) {

								if(find.name === _target_name) {
									return true;
								}

								return false;
								
							});
							
							//해당 타켓의 카운트 숫자가 0일때 조건식
							if( _target_count.value  < 1 ) { 
								cartArray.splice(cartArray_find, 1)
								
								_target.checked  = false;
								_target_count.setAttribute('disabled', 'disabled')
								_target.classList.remove('active')

								//넘버를 0으로 했는데, 체크된것도 0이면 생기는 조건
								if(_checkdAll.length == 0) {

								_carBt.setAttribute('disabled', 'disabled')
									
								} return false
							
							//카운트 넘버가 1이상이때면 해당 조건식 발생
							}else{
								cartArray[cartArray_find].count = _target_count.value
								cartArray[cartArray_find].amount = _target_count.value * _target_data
								_carBt.removeAttribute('disabled')
							
							}
									 												
						})	

					//체크박스를 해제 될때,
					}else{

						_target.classList.remove('active')

						let cartArray_find = cartArray.findIndex(function(find) {

							if(find.name === _target_name) {
								return true;
							}

							return false;
													
						});
											
						cartArray.splice(cartArray_find, 1)
						
						_target_count.setAttribute('disabled', 'disabled')
						_target_count.value = 0

						if( _checkdAll.length == 0 ){

						_carBt.setAttribute('disabled', 'disabled')
						

						}else{

						_carBt.removeAttribute('disabled') //장바구니버튼disabled삭제

						}
					}																		
				})
			}
			
			//장바구니 담기 버튼을 눌렀을 때, 이벤트 생성
			document.getElementById('buyBt').addEventListener('click', function(){
				console.log("현재내가 로컬스토리지에 가지고있는포인트")
				console.log(localStorage.totalPrice)
				let buyconfirm = confirm("구매를 확정하시겠습니까?")

				if(buyconfirm == true){

					localStorage.totalPrice = localStorage.totalPrice - cartListItemTotalval

					alert(cartListItemTotalval+"포인트차감으로 " + localStorage.totalPrice + "포인트가 남게됩니다.")
					document.getElementById('cartWrap').style.display = 'none';
					document.getElementById('price').innerHTML = localStorage.getItem('totalPrice')
					buyArray.push(cartArray, cartArrayTotal)
					console.log("최종구매 배열")
					console.log(buyArray)

				}return false

			})


		}

		function cartWrapClose() {
			document.getElementById('cartWrap').style.display = 'none';
		}

		//초기 포인트 알림
		function _f_initPriceButton(){

		
			document.getElementById('price').addEventListener('click', 	function(){
				alert(localStorage.getItem('totalPrice') + "포인트를 소유하고 있습니다") 

			})
		}

		function _f_initAjaxList(arr){
			
			//innerHTML을 통해 생성
			const _cartlisWrap = document.getElementById('itemList')
			
			const _HTML = ''

			try{
				$.ajax({
					url: `http://127.0.0.1:5500/Stydy10/api/mart.json`,
					method: 'GET',
					async: true,
					dataType: 'json',
					success : function (response) {
					
						arr = response;
												
						// 반복문을 통해 전체 배열 출력
						for(let i=0; i < arr.length; i++ ){
							console.log(arr[i].price)

							// _HTML += "<li class='item'>"+ arr[i].price +"</li>"

							// _HTML += '<li class="item">';
							// 	_HTML += '<input class="name" id="martitemlist'+(i+1)+'" type="checkbox" data-price="'+ arr[i].price +'" name="mart" value="'+martitem[i].name+'" />';
							// 	_HTML += '<label for="martitemlist'+(i+1)+'">'+arr[i].name+'</label>';
							// 	_HTML += '<input class="counts" id="count'+i+'" placeholder="0" disabled min="0" type="number" name="count">';
							// _HTML += '</li>';
						}
						 

					   console.log(_HTML)
					},
					error: function (xhr) {
						alert(xhr)
					}
					
				});
			}
			catch(e){
				//AJAX 로드 실패
				alert(e)
			}
		}	


		//장바구니 담기 버튼
		/**
		 * @param {String} el		대상버튼
		 * @param {Arrary} arr		장바구니 배열
		 * @param {Arrary} total	전체가격포함 배열
		 * 
		*/
		function _f_initWishListButton(el, arr, total){
			
			el.addEventListener('click', function(){

				console.log("장바구니에 담긴 배열")
				console.log(arr)
				
				document.getElementById('cartWrap').style.display = 'block';

				//선택된 제품 배열에서 토탈 합산을 구하기
				cartListItemTotalval = arr.reduce((prev, curr) => {
					return (prev += curr.amount)
				}, 0)

				total.push({totalPrice : cartListItemTotalval})

				let cartListItemWrap = document.getElementById('cartlistWrap')		
				let cartListItemTotalWrap = document.getElementById('cartTotalWrap')					
				let cartList = document.getElementsByClassName('cartListItem')
				let totalPrice = document.getElementById('totalPriceval')

				__HTML = ""
				cartListItemTotalWrap.innerHTML = ""
					
				for(let i=0; i < arr.length; i++){
					
					__HTML += '<tr class="cartListItem">'
						__HTML += '<td>' + arr[i].name + '</td>'
						__HTML += '<td>' + arr[i].price + '</td>'
						__HTML += '<td>' + arr[i].count + '</td>'
						__HTML += '<td>' + arr[i].amount + '</td>'
					__HTML += '</tr>' 
										
				}
													
				cartListItemWrap.innerHTML = __HTML
				cartListItemTotalWrap.innerHTML += '<tr>' + '<td class="total" colspan="2">' + "전체 구매 금액" + '</td>' + '<td id="totalPriceval" class="total" colspan="2" date-total= '+cartListItemTotalval+'>' + cartListItemTotalval + '</td>' + '</tr>'
										
				console.log("장바구니에 담긴 전체 합산금액")
				console.log(cartListItemTotalval)
			})
		}

		
			

	</script>
</head>
<body>
	<div id="container">
		<div id="utilWrap">
			<span>현재 나의 포인트</span>
			<button type="button" id="price"></button>
		</div>
		<h1>Cart 만들기</h1>

		<div id="itemWrap">
			<ul id="itemList">

			</ul>
		</div>
		<button id="cartbt" disabled >장바구니 담기</button>
		<div id="cartWrap">
			<h1>장바구니 리스트</h1>
			<table id="cartTable">
				<thead>
					<tr>
						<td>품목</td>
						<td>단가</td>
						<td>수량</td>
						<td>해당품목 합계</td>
					</tr>
				</thead>
				<tbody id="cartlistWrap">
				</tbody>
				<tfoot id="cartTotalWrap">
				</tfoot>
			</table>
			<button id="buyBt">구매하기</button>
			<button id="closeBt" onclick="cartWrapClose();">다시담기</button>
		</div>
	</div>

	<div id="arrjson">

	</div>


	
<!-- <script type="text/javascript">


1. 장바구니 담기
2. 장바구니 뷰 ()
3. 구매하기 
   > 최종 구매한 것에 대한 배열을 새로 만들고, 
	
</script> -->
</body>
</html>